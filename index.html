<!DOCTYPE html>
<html>
  <head>
    <title>MRRC Safety Test</title>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css">
    <link href="https://unpkg.com/@jspsych/plugin-survey@0.2.2/css/survey.css" rel="text/css">
    <script src="https://unpkg.com/jspsych@7.3.4"> </script>
    <script src="https://unpkg.com/@jspsych/plugin-survey@0.2.2"> </script>
  </head>
  <body></body>
  <script>
    const jsPsych = initJsPsych();
    const questions = {
'on':     {'prompt': 'The magnet is only on when the scanner is making noise.',
           'correct': 'False',
           'wrong': ['True'],
           'message': 'The magnet is <b>ALWAYS</b> on'},
'safety': {'prompt': 'MRI safety mistakes can be fatal',
           'correct': 'True',
           'wrong': ['False'],
           'message': 'MRI scanners can kill in seconds if safety is ignored.'},
}

function feedback_msg(message){
    //const correct = jsPsych.data.get().last(1).values()[0].correct;
    console.log("feedback: ", jsPsych.data.get());
    const correct = true;
    const ctext = correct?"CORRECT":"<span style=color:red>INCORRECT</span>";
    return `<p>  ${ctext} ${message}</p>`;
}
const feedback = { 'type': 'html', prompt: "", on_start: (x) => console.log(feedback_msg())  };

function mk_question(qkey) {
    const q = questions[qkey];
    console.log(q);
    return {
      type: 'multi-choice',
      prompt: q["prompt"],
      options: q["wrong"].concat(q["correct"]),
      correct_response: q["correct"],
      option_reorder: "random",
      required: true,
      on_finish: function(data) { 
          console.log("response: ", data.response)
          //already set by suvey plugin?
          //data.correct = data.response == q["correct"]
      }};
}

function mk_pages(){
    const q = Object.keys(questions);
    const q_r = jsPsych.randomization.shuffle(q);
    const q_and_fbk = q_r.map(qkey=>[[mk_question(qkey)],[feedback]]).flat();
    return q_and_fbk;
    /* like
    return [
     [mk_question('magnet')],
     [feedback]];
    */
}
    
var survey = {
  type: jsPsychSurvey,
  pages: mk_pages,
  title: 'MR Safety',
  button_label_next: 'Continue',
  button_label_back: 'Previous',
  //button_label_finish: 'Submit',
  show_question_numbers: 'on',
  on_finish: function(data) { console.log("TODO: check score shuffle and restart if bad");}
};
    

    jsPsych.run([survey]);

  </script>
</html>
